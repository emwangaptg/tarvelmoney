<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>綺麗旅帳 - Travel Expense V2.2</title>
    
    <!-- 核心函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #fff1f2;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 4px 15px rgba(251, 113, 133, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .btn-pink {
            background: linear-gradient(135deg, #fbcfe8 0%, #f43f5e 100%); color: white;
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3); transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-pink:active { transform: scale(0.95); }
        .btn-pink:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .input-elegant {
            background: #fff; border: 1px solid #fecdd3; border-radius: 12px;
            padding: 10px 14px; outline: none; width: 100%; font-size: 15px;
            transition: border-color 0.3s;
        }
        .input-elegant:focus { border-color: #f43f5e; box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1); }
        .tag-tax { font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .tag-inc { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .tag-exc { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .receipt-thumb { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Loading Animation */
        .loader {
            width: 24px; height: 24px; border: 3px solid #fecdd3; border-bottom-color: #f43f5e;
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Transitions */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-screen max-w-md mx-auto relative overflow-hidden bg-[#fff1f2]">
    
    <!-- Header -->
    <header class="px-6 pt-12 pb-4 flex justify-between items-end bg-white/50 backdrop-blur-md sticky top-0 z-10">
        <div>
            <div class="text-xs text-rose-400 font-bold tracking-widest mb-1">TRAVEL EXPENSE</div>
            <h1 class="text-2xl font-bold text-slate-800">綺麗旅帳 <i class="fa-solid fa-plane-departure text-rose-400 ml-1"></i></h1>
        </div>
        <button @click="showSettings = true" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-rose-400 hover:bg-rose-50 transition relative">
            <i class="fa-solid fa-gear"></i>
            <span v-if="!settings.apiKey" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto px-4 pb-24 scroll-smooth">
        
        <!-- Rate Info -->
        <div class="card p-4 mb-6 flex justify-between items-center bg-gradient-to-r from-rose-50 to-pink-50 border-rose-100">
            <div>
                <p class="text-xs text-rose-400 mb-1">當前匯率</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-xl font-bold text-rose-600">1 {{ currencyCode }}</span>
                    <span class="text-gray-400 text-sm">=</span>
                    <span class="text-xl font-bold text-slate-700">{{ settings.rate }} TWD</span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-500 mb-1">累積消費 (TWD)</p>
                <p class="text-2xl font-bold text-slate-800">{{ formatCurrency(totalTWD) }}</p>
            </div>
        </div>

        <!-- Expense List -->
        <div v-if="Object.keys(groupedExpenses).length === 0" class="text-center py-20 opacity-50">
            <i class="fa-solid fa-bag-shopping text-6xl text-rose-200 mb-4"></i>
            <p>還沒有敗家紀錄<br>快去設定 API Key 並開始記帳吧！</p>
        </div>

        <div v-for="(dayExpenses, date) in groupedExpenses" :key="date" class="mb-6 animate-fade-in">
            <div class="flex items-center gap-3 mb-3 px-2">
                <span class="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-lg">{{ getDayLabel(date) }}</span>
                <span class="text-sm font-bold text-gray-600">{{ formatDate(date) }}</span>
                <div class="h-[1px] bg-rose-200 flex-1"></div>
                <span class="text-xs font-bold text-gray-400">NT$ {{ formatCurrency(getDayTotal(dayExpenses)) }}</span>
            </div>

            <div class="space-y-3">
                <div v-for="item in dayExpenses" :key="item.id" class="card p-3 flex gap-3 items-center relative overflow-hidden group">
                    <button @click="deleteExpense(item.id)" class="absolute right-0 top-0 bottom-0 w-12 bg-red-500 text-white translate-x-full group-hover:translate-x-0 transition-transform flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <div class="shrink-0 cursor-pointer" @click="viewImage(item.image)">
                        <img :src="item.image || 'https://via.placeholder.com/150?text=No+Img'" class="receipt-thumb" alt="receipt">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-0.5">
                            <h3 class="font-bold text-slate-800 truncate text-base">{{ item.itemTw }}</h3>
                            <span class="text-sm font-bold text-rose-500">NT$ {{ formatCurrency(Math.round(item.price * settings.rate)) }}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <div class="flex items-center gap-2">
                                <span class="truncate max-w-[80px]"><i class="fa-solid fa-store mr-1 text-rose-300"></i>{{ item.store }}</span>
                                <span class="bg-gray-100 px-1.5 py-0.5 rounded text-[10px]">{{ item.itemOriginal }}</span>
                            </div>
                            <span class="font-mono">{{ formatCurrency(item.price) }} {{ currencyCode }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FAB (Updated Position to bottom-32) -->
    <button @click="openAddModal" class="absolute bottom-32 right-6 w-14 h-14 rounded-full btn-pink flex items-center justify-center text-2xl shadow-xl z-20 hover:scale-110 transition-transform">
        <i class="fa-solid fa-camera"></i>
    </button>

    <!-- Add Expense Modal -->
    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-30 flex items-end sm:items-center justify-center">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeModal"></div>
            <transition name="slide-up">
                <div v-if="showModal" class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 relative z-40 max-h-[90vh] overflow-y-auto flex flex-col shadow-2xl">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">紀錄美好消費</h2>

                    <!-- Image Preview Area -->
                    <div class="mb-4 relative group">
                        <div v-if="!form.image" class="w-full h-40 bg-rose-50 rounded-2xl border-2 border-dashed border-rose-200 flex flex-col items-center justify-center text-rose-300 cursor-pointer hover:bg-rose-100 transition" @click="triggerCamera">
                            <div class="flex gap-4 text-3xl mb-2">
                                <i class="fa-solid fa-camera"></i>
                                <i class="fa-regular fa-image"></i>
                            </div>
                            <span class="text-sm font-bold">拍照 或 從相簿上傳</span>
                            <span class="text-xs text-rose-300 mt-1">(支援 AI 自動辨識)</span>
                        </div>
                        <div v-else class="relative w-full h-48 rounded-2xl overflow-hidden shadow-sm bg-black/5">
                            <img :src="form.image" class="w-full h-full object-contain">
                            <button @click="triggerCamera" class="absolute bottom-2 right-2 bg-white/80 p-2 rounded-full text-gray-600 text-sm font-bold shadow hover:bg-white z-10">
                                <i class="fa-solid fa-rotate mr-1"></i> 重選
                            </button>
                            <!-- Analyzing Overlay -->
                            <div v-if="isAnalyzing" class="absolute inset-0 bg-white/60 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                                <span class="loader mb-2"></span>
                                <span class="text-rose-500 font-bold text-sm">{{ statusText }}</span>
                            </div>
                        </div>
                        <!-- Updated Input: Explicitly removed capture attribute to allow gallery selection -->
                        <input type="file" ref="fileInput" accept="image/*" class="hidden" @change="handleImageUpload">
                    </div>

                    <!-- AI Retry Button -->
                    <button v-if="form.image && !isAnalyzing" @click="analyzeReceipt" class="w-full mb-4 py-2 bg-gradient-to-r from-violet-50 to-fuchsia-50 text-violet-600 rounded-xl text-xs font-bold border border-violet-100 hover:brightness-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> 
                        {{ settings.apiKey ? '重新執行 AI 辨識' : '請先設定 API Key' }}
                    </button>

                    <!-- Form Fields -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">日期</label><input type="date" v-model="form.date" class="input-elegant"></div>
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">店舖名稱</label><input type="text" v-model="form.store" class="input-elegant"></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">品項名稱 (繁中)</label><input type="text" v-model="form.itemTw" class="input-elegant"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">原文品名</label><input type="text" v-model="form.itemOriginal" class="input-elegant text-sm text-gray-500"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">金額 ({{currencyCode}})</label><input type="number" v-model.number="form.price" class="input-elegant font-mono text-lg font-bold text-rose-500"></div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 mb-1 block">稅務</label>
                                <div class="flex bg-gray-100 p-1 rounded-xl h-[46px]">
                                    <button @click="form.tax = 'inc'" :class="['flex-1 rounded-lg text-xs font-bold transition', form.tax === 'inc' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400']">含稅</button>
                                    <button @click="form.tax = 'exc'" :class="['flex-1 rounded-lg text-xs font-bold transition', form.tax === 'exc' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400']">未稅</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl flex justify-between items-center">
                            <span class="text-xs text-gray-500">換算台幣 (約)</span>
                            <span class="font-bold text-slate-700">NT$ {{ formatCurrency(Math.round(form.price * settings.rate)) }}</span>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button @click="closeModal" class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-500 font-bold bg-white">取消</button>
                        <button @click="saveExpense" class="flex-[2] py-3 rounded-xl btn-pink font-bold shadow-lg shadow-rose-200" :disabled="isAnalyzing">確認記帳</button>
                    </div>
                </div>
            </transition>
        </div>
    </transition>

    <!-- Settings Modal -->
    <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
            <button @click="saveSettings" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">旅程設定</h3>
            <div class="space-y-5">
                <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
                    <label class="text-xs font-bold text-rose-600 mb-1 block"><i class="fa-solid fa-key mr-1"></i>Google Gemini API Key</label>
                    <input type="password" v-model="settings.apiKey" placeholder="貼上 API Key (AIza...)" class="input-elegant text-sm">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-rose-400 underline mt-1 block text-right">免費申請 Key</a>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-1 block">當地貨幣</label>
                    <select v-model="settings.currencyCode" class="input-elegant bg-white">
                        <option value="JPY">JPY (日圓)</option><option value="KRW">KRW (韓元)</option>
                        <option value="USD">USD (美金)</option><option value="EUR">EUR (歐元)</option>
                        <option value="THB">THB (泰銖)</option><option value="CNY">CNY (人民幣)</option>
                    </select>
                </div>
                <div><label class="text-xs font-bold text-gray-500 mb-1 block">匯率 (1 當地幣 = ? 台幣)</label><input type="number" v-model.number="settings.rate" step="0.0001" class="input-elegant font-bold text-rose-500"></div>
            </div>
            <button @click="saveSettings" class="w-full mt-6 py-3 rounded-xl btn-pink font-bold">儲存</button>
        </div>
    </div>

    <!-- Image Viewer -->
    <div v-if="viewingImage" class="fixed inset-0 bg-black/90 z-[60] flex flex-col justify-center items-center p-4" @click="viewingImage = null">
        <img :src="viewingImage" class="max-w-full max-h-[80vh] object-contain rounded-lg">
        <p class="text-white/70 text-sm mt-4">點擊任意處關閉</p>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
        setup() {
            const showModal = ref(false);
            const showSettings = ref(false);
            const viewingImage = ref(null);
            const fileInput = ref(null);
            const isAnalyzing = ref(false);
            const statusText = ref('');
            
            const settings = reactive({ rate: 0.2150, currencyCode: 'JPY', apiKey: '' });
            const expenses = ref([]);
            
            const form = reactive({ id: null, date: '', store: '', itemTw: '', itemOriginal: '', price: '', tax: 'inc', image: null });

            onMounted(() => {
                const savedExp = localStorage.getItem('myTravel_expenses');
                const savedSet = localStorage.getItem('myTravel_settings');
                if (savedExp) expenses.value = JSON.parse(savedExp);
                if (savedSet) Object.assign(settings, JSON.parse(savedSet));
                resetForm();
            });

            const saveAll = () => {
                localStorage.setItem('myTravel_expenses', JSON.stringify(expenses.value));
                localStorage.setItem('myTravel_settings', JSON.stringify(settings));
            };

            const resetForm = () => {
                Object.assign(form, {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    store: '', itemTw: '', itemOriginal: '', price: '', tax: 'inc', image: null
                });
            };

            const openAddModal = () => { resetForm(); showModal.value = true; };
            const closeModal = () => showModal.value = false;
            const saveSettings = () => { saveAll(); showSettings.value = false; };
            const triggerCamera = () => fileInput.value.click();

            const cleanJsonString = (str) => {
                const match = str.match(/\{[\s\S]*\}/);
                return match ? match[0] : str;
            };

            const analyzeReceipt = async () => {
                if (!settings.apiKey) { alert("請先至設定輸入 API Key"); return; }
                if (!form.image) return;

                isAnalyzing.value = true;
                statusText.value = "影像上傳與分析中...";

                try {
                    const base64Image = form.image.split(',')[1];
                    const prompt = `
                        請扮演一個收據辨識專家。請分析這張圖片，並以繁體中文 (Traditional Chinese) 回傳一個純 JSON 物件。
                        
                        你需要提取：
                        1. store: 店家名稱 (原文)。
                        2. itemOriginal: 最主要的商品名稱 (原文)，如果是多項商品，請選金額最高的。
                        3. itemTw: 將上述商品名稱翻譯成台灣繁體中文 (精簡)。
                        4. price: 總金額 (純數字，不要符號，不要千分位逗號)。
                        5. date: 交易日期 (格式 YYYY-MM-DD，若找不到則回傳空字串)。

                        請務必只回傳 JSON 字串，不要有任何 Markdown 標記或解釋文字。格式如下：
                        {"store": "...", "itemOriginal": "...", "itemTw": "...", "price": 0, "date": "..."}
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);
                    if (!data.candidates || !data.candidates[0].content) throw new Error("AI 無法辨識此圖片");

                    statusText.value = "資料解析中...";
                    const rawText = data.candidates[0].content.parts[0].text;
                    const jsonStr = cleanJsonString(rawText);
                    const result = JSON.parse(jsonStr);

                    form.store = result.store || '';
                    form.itemTw = result.itemTw || '';
                    form.itemOriginal = result.itemOriginal || '';
                    form.price = result.price || '';
                    if (result.date) form.date = result.date;
                    
                } catch (error) {
                    console.error(error);
                    alert(`辨識失敗: ${error.message}\n請檢查 API Key 是否正確，或收據是否清晰。`);
                } finally {
                    isAnalyzing.value = false;
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.src = evt.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 1024;
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        form.image = canvas.toDataURL('image/jpeg', 0.8);
                        if(settings.apiKey) analyzeReceipt();
                    };
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const saveExpense = () => {
                if (!form.itemTw || !form.price) { alert('請輸入完整資訊'); return; }
                expenses.value.push({ ...form });
                saveAll();
                closeModal();
            };

            const deleteExpense = (id) => { if(confirm('刪除?')) { expenses.value = expenses.value.filter(i => i.id !== id); saveAll(); } };
            const viewImage = (src) => { if(src) viewingImage.value = src; };

            const currencyCode = computed(() => settings.currencyCode);
            const totalTWD = computed(() => expenses.value.reduce((sum, item) => sum + Math.round(item.price * settings.rate), 0));
            const groupedExpenses = computed(() => {
                const groups = {};
                const sorted = [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(item => {
                    if (!groups[item.date]) groups[item.date] = [];
                    groups[item.date].push(item);
                });
                return groups;
            });

            const formatCurrency = (val) => (!val && val !== 0) ? '-' : Number(val).toLocaleString();
            const formatDate = (d) => { const date = new Date(d); return `${date.getMonth()+1}月${date.getDate()}日`; };
            const getDayLabel = (d) => ['週日','週一','週二','週三','週四','週五','週六'][new Date(d).getDay()];
            const getDayTotal = (items) => items.reduce((sum, item) => sum + Math.round(item.price * settings.rate), 0);

            return {
                showModal, showSettings, viewingImage, fileInput, isAnalyzing, statusText,
                settings, form, currencyCode, groupedExpenses, totalTWD,
                openAddModal, closeModal, triggerCamera, handleImageUpload, analyzeReceipt, saveExpense, saveSettings, deleteExpense, viewImage,
                formatCurrency, formatDate, getDayLabel, getDayTotal
            };
        }
    }).mount('#app');
</script>

</body>
</html>
