<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶ºéº—æ—…å¸³ - Travel Expense V5.7 (é›¢ç·šOCRæ•´åˆç‰ˆ)</title>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #fff1f2;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 20px; box-shadow: 0 4px 15px rgba(251, 113, 133, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .btn-pink {
            background: linear-gradient(135deg, #fbcfe8 0%, #f43f5e 100%); color: white;
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3); transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-pink:active { transform: scale(0.95); }
        .btn-pink:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .input-elegant {
            background: #fff; border: 1px solid #fecdd3; border-radius: 12px;
            padding: 10px 14px; outline: none; width: 100%; font-size: 15px;
            transition: border-color 0.3s;
        }
        .input-elegant:focus { border-color: #f43f5e; box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1); }
        
        .tab-btn {
            padding: 8px 6px; border-radius: 12px; font-size: 12px; font-weight: bold; transition: all 0.3s;
            border: 1px solid transparent; width: 100%; text-align: center;
        }
        .tab-btn.active {
            background-color: #fff; color: #db2777; border-color: #fbcfe8; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn.inactive {
            background-color: transparent; color: #9ca3af;
        }

        .tag-tax { font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .tag-inc { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .tag-exc { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .receipt-thumb { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .loader { width: 24px; height: 24px; border: 3px solid #fecdd3; border-bottom-color: #f43f5e; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

        .progress-bar { width: 100%; height: 6px; background-color: #e5e7eb; border-radius: 99px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background-color: #db2777; transition: width 0.3s ease; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-screen max-w-md mx-auto relative overflow-hidden bg-[#fff1f2]">
    
    <!-- Header -->
    <header class="px-6 pt-12 pb-4 flex justify-between items-end bg-white/50 backdrop-blur-md sticky top-0 z-10">
        <div>
            <div class="text-xs text-rose-400 font-bold tracking-widest mb-1">TRAVEL EXPENSE</div>
            <h1 class="text-2xl font-bold text-slate-800">ç¶ºéº—æ—…å¸³ <i class="fa-solid fa-plane-departure text-rose-400 ml-1"></i></h1>
        </div>
        <button @click="showSettings = true" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-rose-400 hover:bg-rose-50 transition relative">
            <i class="fa-solid fa-gear"></i>
            <span v-if="(settings.provider === 'gemini' && !settings.geminiKey) || (settings.provider === 'openai' && !settings.openaiKey)" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-ping"></span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto px-4 pb-24 scroll-smooth">
        <div class="card p-4 mb-6 flex justify-between items-center bg-gradient-to-r from-rose-50 to-pink-50 border-rose-100">
            <div>
                <p class="text-xs text-rose-400 mb-1">ç•¶å‰åŒ¯ç‡</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-xl font-bold text-rose-600">1 {{ currencyCode }}</span>
                    <span class="text-gray-400 text-sm">=</span>
                    <span class="text-xl font-bold text-slate-700">{{ settings.rate }} TWD</span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-500 mb-1">ç´¯ç©æ¶ˆè²» (TWD)</p>
                <p class="text-2xl font-bold text-slate-800">{{ formatCurrency(totalTWD) }}</p>
            </div>
        </div>

        <div v-if="Object.keys(groupedExpenses).length === 0" class="text-center py-20 opacity-50">
            <i class="fa-solid fa-bag-shopping text-6xl text-rose-200 mb-4"></i>
            <p>é‚„æ²’æœ‰æ•—å®¶ç´€éŒ„<br>å¿«å»è¨˜å¸³å§ï¼</p>
        </div>

        <div v-for="(dayExpenses, date) in groupedExpenses" :key="date" class="mb-6 animate-fade-in">
            <div class="flex items-center gap-3 mb-3 px-2">
                <span class="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-lg">{{ getDayLabel(date) }}</span>
                <span class="text-sm font-bold text-gray-600">{{ formatDate(date) }}</span>
                <div class="h-[1px] bg-rose-200 flex-1"></div>
                <span class="text-xs font-bold text-gray-400">NT$ {{ formatCurrency(getDayTotal(dayExpenses)) }}</span>
            </div>

            <div class="space-y-3">
                <div v-for="item in dayExpenses" :key="item.id" class="card p-3 flex gap-3 items-center relative overflow-hidden group">
                    <button @click="deleteExpense(item.id)" class="absolute right-0 top-0 bottom-0 w-12 bg-red-500 text-white translate-x-full group-hover:translate-x-0 transition-transform flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                    <div class="shrink-0 cursor-pointer" @click="viewImage(item.image)"><img :src="item.image || 'https://via.placeholder.com/150?text=No+Img'" class="receipt-thumb" alt="receipt"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-0.5">
                            <h3 class="font-bold text-slate-800 truncate text-base">{{ item.itemTw }}</h3>
                            <span class="text-sm font-bold text-rose-500">NT$ {{ formatCurrency(Math.round(item.price * settings.rate)) }}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <div class="flex items-center gap-2"><span class="truncate max-w-[80px]"><i class="fa-solid fa-store mr-1 text-rose-300"></i>{{ item.store }}</span><span class="bg-gray-100 px-1.5 py-0.5 rounded text-[10px]">{{ item.itemOriginal }}</span></div>
                            <span class="font-mono">{{ formatCurrency(item.price) }} {{ currencyCode }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <button @click="openAddModal" class="absolute bottom-32 right-6 w-14 h-14 rounded-full btn-pink flex items-center justify-center text-2xl shadow-xl z-20 hover:scale-110 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Add Expense Modal -->
    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-30 flex items-end sm:items-center justify-center">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeModal"></div>
            <transition name="slide-up">
                <div v-if="showModal" class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 relative z-40 max-h-[90vh] overflow-y-auto flex flex-col shadow-2xl">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">ç´€éŒ„ç¾å¥½æ¶ˆè²»</h2>

                    <!-- Image Preview Area -->
                    <div class="mb-4 relative group">
                        <div v-if="!form.image" class="w-full h-40 bg-rose-50 rounded-2xl border-2 border-dashed border-rose-200 flex flex-col items-center justify-center text-rose-300 cursor-pointer hover:bg-rose-100 transition" @click="triggerCamera">
                            <div class="flex gap-4 text-3xl mb-2"><i class="fa-solid fa-camera"></i><i class="fa-regular fa-image"></i></div>
                            <span class="text-sm font-bold">æ‹ç…§ æˆ– å¾ç›¸ç°¿ä¸Šå‚³</span>
                            <span class="text-xs text-rose-300 mt-1">(æ”¯æ´ {{ getProviderName() }} è‡ªå‹•è¾¨è­˜)</span>
                        </div>
                        <div v-else class="relative w-full h-48 rounded-2xl overflow-hidden shadow-sm bg-black/5">
                            <img :src="form.image" class="w-full h-full object-contain">
                            <button @click="triggerCamera" class="absolute bottom-2 right-2 bg-white/80 p-2 rounded-full text-gray-600 text-sm font-bold shadow hover:bg-white z-10"><i class="fa-solid fa-rotate mr-1"></i> é‡é¸</button>
                             <!-- Analyzing Overlay -->
                            <div v-if="isAnalyzing" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm text-center px-4">
                                <span class="loader mb-3"></span>
                                <span class="text-rose-500 font-bold text-base mb-1">{{ isOfflineOCR ? 'é›¢ç·š OCR åˆ†æä¸­...' : (getProviderName() + ' æ­£åœ¨è®€å–æ”¶æ“š...') }}</span>
                                <span class="text-xs text-gray-500 block whitespace-pre-wrap">{{ statusText }}</span>
                            </div>
                        </div>
                        <input type="file" ref="fileInput" accept="image/*" class="hidden" @change="handleImageUpload">
                    </div>

                    <!-- AI/OCR Retry Button -->
                    <button v-if="form.image && !isAnalyzing" @click="analyzeReceipt" class="w-full mb-4 py-2 bg-gradient-to-r from-violet-50 to-fuchsia-50 text-violet-600 rounded-xl text-xs font-bold border border-violet-100 hover:brightness-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> 
                        {{ isOfflineOCR ? 'åŸ·è¡Œé›¢ç·š OCR è¾¨è­˜' : (isKeyConfigured ? 'é‡æ–°åŸ·è¡Œ AI è¾¨è­˜' : 'è«‹å…ˆè¨­å®š API Key') }}
                    </button>

                    <!-- Form Fields -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">æ—¥æœŸ</label><input type="date" v-model="form.date" class="input-elegant"></div>
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">åº—èˆ–åç¨±</label><input type="text" v-model="form.store" class="input-elegant"></div>
                        </div>
                        
                        <!-- Item Name with Translation -->
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">åŸæ–‡å“å (é¸å¡«)</label>
                            <div class="flex gap-2">
                                <input type="text" v-model="form.itemOriginal" class="input-elegant text-sm text-gray-500 flex-1" placeholder="è¼¸å…¥åŸæ–‡è‡ªå‹•ç¿»è­¯">
                                <button v-if="!isAIProvider" @click="translateItem" class="bg-blue-50 text-blue-600 px-3 rounded-xl border border-blue-100 hover:bg-blue-100 transition whitespace-nowrap text-sm font-bold"><i class="fa-solid fa-language mr-1"></i>ç¿»è­¯</button>
                            </div>
                            <div v-if="isDownloadingModel" class="mt-2 text-xs text-violet-600 bg-violet-50 p-2 rounded animate-pulse">æ­£åœ¨è‡ªå‹•ä¸‹è¼‰/è¼‰å…¥é›¢ç·šç¿»è­¯æ¨¡å‹... è«‹ç¨å€™ (ç´„ 1-2 åˆ†é˜)ã€‚</div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">å“é …åç¨± (ç¹ä¸­)</label>
                            <input type="text" v-model="form.itemTw" class="input-elegant" placeholder="è¼¸å…¥æˆ–ç”±ä¸Šæ–¹è‡ªå‹•ç¿»è­¯">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 mb-1 block">é‡‘é¡ ({{currencyCode}})</label><input type="number" v-model.number="form.price" class="input-elegant font-mono text-lg font-bold text-rose-500"></div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 mb-1 block">ç¨…å‹™</label>
                                <div class="flex bg-gray-100 p-1 rounded-xl h-[46px]">
                                    <button @click="form.tax = 'inc'" :class="['flex-1 rounded-lg text-xs font-bold transition', form.tax === 'inc' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400']">å«ç¨…</button>
                                    <button @click="form.tax = 'exc'" :class="['flex-1 rounded-lg text-xs font-bold transition', form.tax === 'exc' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400']">æœªç¨…</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl flex justify-between items-center">
                            <span class="text-xs text-gray-500">æ›ç®—å°å¹£ (ç´„)</span>
                            <span class="font-bold text-slate-700">NT$ {{ formatCurrency(Math.round(form.price * settings.rate)) }}</span>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button @click="closeModal" class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-500 font-bold bg-white">å–æ¶ˆ</button>
                        <button @click="saveExpense" class="flex-[2] py-3 rounded-xl btn-pink font-bold shadow-lg shadow-rose-200" :disabled="isAnalyzing">ç¢ºèªè¨˜å¸³</button>
                    </div>
                </div>
            </transition>
        </div>
    </transition>

    <!-- Settings Modal -->
    <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button @click="saveSettings" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-5">
                
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-2 block">è¾¨è­˜/ç¿»è­¯æ–¹å¼</label>
                    <div class="grid grid-cols-2 gap-2 bg-slate-50 p-1 rounded-xl">
                        <button @click="settings.provider = 'gemini'" :class="['tab-btn', settings.provider === 'gemini' ? 'active' : 'inactive']">Gemini</button>
                        <button @click="settings.provider = 'openai'" :class="['tab-btn', settings.provider === 'openai' ? 'active' : 'inactive']">ChatGPT</button>
                        <button @click="settings.provider = 'dictionary'" :class="['tab-btn', settings.provider === 'dictionary' ? 'active' : 'inactive']">ç°¡æ˜“å­—å…¸</button>
                        <button @click="settings.provider = 'offline_ai'" :class="['tab-btn', settings.provider === 'offline_ai' ? 'active' : 'inactive']">é›¢ç·š AI+OCR</button>
                        <div class="col-span-2 flex justify-center mt-1">
                             <button @click="settings.provider = 'google_trans'" :class="['tab-btn', settings.provider === 'google_trans' ? 'active' : 'inactive', 'w-1/2']">Google ç¿»è­¯</button>
                        </div>
                    </div>
                </div>

                <div v-if="settings.provider === 'gemini'" class="bg-rose-50 p-3 rounded-xl border border-rose-100 animate-fade-in">
                    <label class="text-xs font-bold text-rose-600 mb-1 block"><i class="fa-solid fa-key mr-1"></i>Gemini API Key</label>
                    <input type="password" v-model="settings.geminiKey" placeholder="AIza..." class="input-elegant text-sm">
                    <label class="text-xs font-bold text-gray-500 mt-3 mb-1 block">æ¨¡å‹</label>
                    <select v-model="settings.geminiModel" class="input-elegant bg-white text-xs">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (å¿«é€Ÿ/æ¨è–¦)</option>
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (ç²¾æº–)</option>
                         <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æœ€æ–°å¯¦é©—ç‰ˆ)</option>
                    </select>
                    <div class="flex justify-between items-center mt-2">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-rose-400 underline">å…è²»ç”³è«‹ Key</a>
                        <button @click="testAPIConnection" class="text-[10px] bg-white border border-rose-200 text-rose-500 px-2 py-1 rounded hover:bg-rose-50" :disabled="isTesting">{{ isTesting ? 'æ¸¬è©¦ä¸­...' : 'æ¸¬è©¦é€£ç·š' }}</button>
                    </div>
                </div>

                <div v-if="settings.provider === 'openai'" class="bg-blue-50 p-3 rounded-xl border border-blue-100 animate-fade-in">
                    <label class="text-xs font-bold text-blue-600 mb-1 block"><i class="fa-solid fa-key mr-1"></i>OpenAI API Key</label>
                    <input type="password" v-model="settings.openaiKey" placeholder="sk-..." class="input-elegant text-sm">
                    <label class="text-xs font-bold text-gray-500 mt-3 mb-1 block">æ¨¡å‹</label>
                    <select v-model="settings.openaiModel" class="input-elegant bg-white text-xs">
                        <option value="gpt-4o">GPT-4o (æ¨è–¦)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (çœéŒ¢)</option>
                    </select>
                    <div class="flex justify-between items-center mt-2">
                        <a href="https://platform.openai.com/api-keys" target="_blank" class="text-[10px] text-blue-500 underline">ç”³è«‹ OpenAI Key</a>
                        <button @click="testAPIConnection" class="text-[10px] bg-white border border-blue-200 text-blue-500 px-2 py-1 rounded hover:bg-blue-50" :disabled="isTesting">{{ isTesting ? 'æ¸¬è©¦ä¸­...' : 'æ¸¬è©¦é€£ç·š' }}</button>
                    </div>
                </div>
                
                <div v-if="settings.provider === 'offline_ai'" class="bg-violet-50 p-3 rounded-xl border border-violet-100 animate-fade-in text-xs text-violet-700">
                    <p class="font-bold mb-2"><i class="fa-solid fa-robot mr-1"></i> é›¢ç·š AI (OCR + ç¿»è­¯)</p>
                    <p class="mb-3">è«‹ä¾éœ€æ±‚ä¸‹è¼‰å°æ‡‰çš„èªè¨€æ¨¡çµ„ã€‚é¦–æ¬¡ä½¿ç”¨éœ€ç­‰å¾…ä¸‹è¼‰ã€‚</p>
                    <div class="space-y-2">
                        <button @click="downloadModel('ja')" :class="['w-full flex justify-between items-center px-3 py-2 rounded-lg border transition', downloadedModels.includes('ja') ? 'bg-green-50 border-green-200' : 'bg-white border-violet-200 hover:bg-violet-50']" :disabled="isDownloadingModel">
                            <span>ğŸ‡¯ğŸ‡µ æ—¥æ–‡ -> ä¸­æ–‡</span><span :class="downloadedModels.includes('ja') ? 'text-green-600 font-bold' : 'text-violet-500 font-bold'">{{ downloadedModels.includes('ja') ? 'âœ… å·²ä¸‹è¼‰' : (isDownloadingModel && currentDownloadTarget === 'ja' ? 'ä¸‹è¼‰ä¸­...' : 'ğŸ“¥ ä¸‹è¼‰') }}</span>
                        </button>
                        <button @click="downloadModel('ko')" :class="['w-full flex justify-between items-center px-3 py-2 rounded-lg border transition', downloadedModels.includes('ko') ? 'bg-green-50 border-green-200' : 'bg-white border-violet-200 hover:bg-violet-50']" :disabled="isDownloadingModel">
                            <span>ğŸ‡°ğŸ‡· éŸ“æ–‡ -> ä¸­æ–‡</span><span :class="downloadedModels.includes('ko') ? 'text-green-600 font-bold' : 'text-violet-500 font-bold'">{{ downloadedModels.includes('ko') ? 'âœ… å·²ä¸‹è¼‰' : (isDownloadingModel && currentDownloadTarget === 'ko' ? 'ä¸‹è¼‰ä¸­...' : 'ğŸ“¥ ä¸‹è¼‰') }}</span>
                        </button>
                        <button @click="downloadModel('en')" :class="['w-full flex justify-between items-center px-3 py-2 rounded-lg border transition', downloadedModels.includes('en') ? 'bg-green-50 border-green-200' : 'bg-white border-violet-200 hover:bg-violet-50']" :disabled="isDownloadingModel">
                            <span>ğŸ‡ºğŸ‡¸ è‹±æ–‡ -> ä¸­æ–‡</span><span :class="downloadedModels.includes('en') ? 'text-green-600 font-bold' : 'text-violet-500 font-bold'">{{ downloadedModels.includes('en') ? 'âœ… å·²ä¸‹è¼‰' : (isDownloadingModel && currentDownloadTarget === 'en' ? 'ä¸‹è¼‰ä¸­...' : 'ğŸ“¥ ä¸‹è¼‰') }}</span>
                        </button>
                    </div>
                     <button @click="resetDownloadState" class="w-full mt-3 px-3 py-2 bg-white border border-red-200 text-red-500 rounded-lg font-bold hover:bg-red-50 text-center"><i class="fa-solid fa-rotate-right mr-1"></i> é‡ç½®ä¸‹è¼‰ç‹€æ…‹</button>
                    <div v-if="modelLoading.total > 0" class="mt-3">
                         <div class="flex justify-between text-xs text-violet-600 mb-1"><span>{{ modelLoading.text }}</span><span>{{ Math.round((modelLoading.loaded / modelLoading.total) * 100) }}%</span></div>
                        <div class="progress-bar"><div class="progress-fill" :style="{ width: (modelLoading.loaded / modelLoading.total * 100) + '%' }"></div></div>
                    </div>
                </div>

                <div class="h-[1px] bg-gray-100 my-2"></div>
                <div><label class="text-xs font-bold text-gray-500 mb-1 block">ç•¶åœ°è²¨å¹£</label><select v-model="settings.currencyCode" class="input-elegant bg-white"><option value="JPY">JPY (æ—¥åœ“)</option><option value="KRW">KRW (éŸ“å…ƒ)</option><option value="USD">USD (ç¾é‡‘)</option><option value="EUR">EUR (æ­å…ƒ)</option><option value="THB">THB (æ³°éŠ–)</option><option value="CNY">CNY (äººæ°‘å¹£)</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 mb-1 block">åŒ¯ç‡ (1 ç•¶åœ°å¹£ = ? å°å¹£)</label><input type="number" v-model.number="settings.rate" step="0.0001" class="input-elegant font-bold text-rose-500"></div>
            </div>
            <button @click="saveSettings" class="w-full mt-6 py-3 rounded-xl btn-pink font-bold">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <!-- Error Modal -->
    <div v-if="errorModal.show" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-bounce-in">
            <div class="text-center mb-4"><i class="fa-solid fa-triangle-exclamation text-4xl text-amber-400 mb-2"></i><h3 class="text-lg font-bold text-slate-800">å“å‘€ï¼å‡ºéŒ¯äº†</h3></div>
            <div class="bg-gray-100 p-3 rounded-lg text-xs font-mono text-gray-600 mb-4 break-words max-h-32 overflow-y-auto">{{ errorModal.message }}</div>
            <button @click="errorModal.show = false" class="w-full py-2 rounded-xl bg-slate-100 text-slate-600 font-bold">é—œé–‰</button>
        </div>
    </div>
    <div v-if="viewingImage" class="fixed inset-0 bg-black/90 z-[60] flex flex-col justify-center items-center p-4" @click="viewingImage = null"><img :src="viewingImage" class="max-w-full max-h-[80vh] object-contain rounded-lg"><p class="text-white/70 text-sm mt-4">é»æ“Šä»»æ„è™•é—œé–‰</p></div>
</div>

<!-- Transformers.js & Tesseract.js script import -->
<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
    env.allowLocalModels = false;

    class TranslationService {
        static instances = {};
        static types = {}; 

        static async getInstance(lang, progressCallback) {
            if (!this.instances[lang]) {
                let modelID;
                if (lang === 'ja' || lang === 'ko') {
                    modelID = 'Xenova/nllb-200-distilled-600M';
                    this.types[lang] = 'nllb';
                } else {
                    modelID = 'Xenova/opus-mt-en-zh';
                    this.types[lang] = 'opus';
                }
                this.instances[lang] = await pipeline('translation', modelID, { progress_callback: progressCallback });
            }
            return { translator: this.instances[lang], type: this.types[lang] };
        }
    }
    window.TranslationService = TranslationService;
</script>

<script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    const DICTIONARY = {'æ°´': 'Water', 'water': 'æ°´', 'ã¿ãš': 'æ°´', 'ë¬¼': 'æ°´', 'ç‰›å¥¶': 'Milk', 'milk': 'ç‰›å¥¶', 'ç‰›ä¹³': 'ç‰›å¥¶', 'ìš°ìœ ': 'ç‰›å¥¶', 'å’–å•¡': 'Coffee', 'coffee': 'å’–å•¡', 'ã‚³ãƒ¼ãƒ’ãƒ¼': 'å’–å•¡', 'ì»¤í”¼': 'å’–å•¡', 'èŒ¶': 'Tea', 'tea': 'èŒ¶', 'ãŠèŒ¶': 'èŒ¶', 'ì°¨': 'èŒ¶', 'ä¾¿ç•¶': 'Bento', 'bento': 'ä¾¿ç•¶', 'å¼å½“': 'ä¾¿ç•¶', 'ë„ì‹œë½': 'ä¾¿ç•¶', 'éºµåŒ…': 'Bread', 'bread': 'éºµåŒ…', 'ãƒ‘ãƒ³': 'éºµåŒ…', 'ë¹µ': 'éºµåŒ…', 'è—¥å¦': 'Drugstore', 'drug': 'è—¥å¦', 'è–¬': 'è—¥å¦', 'ì•½': 'è—¥å¦', 'é–€ç¥¨': 'Ticket', 'ticket': 'é–€ç¥¨', 'ãƒã‚±ãƒƒãƒˆ': 'é–€ç¥¨', 'í‹°ì¼“': 'é–€ç¥¨', 'äº¤é€š': 'Transport', 'transport': 'äº¤é€š', 'äº¤é€šè²»': 'äº¤é€š', 'êµí†µ': 'äº¤é€š', 'ä½å®¿': 'Hotel', 'hotel': 'ä½å®¿', 'ãƒ›ãƒ†ãƒ«': 'ä½å®¿', 'í˜¸í…”': 'ä½å®¿', 'ç¦®ç‰©': 'Gift', 'gift': 'ç¦®ç‰©', 'ãŠåœŸç”£': 'ä¼´æ‰‹ç¦®', 'ì„ ë¬¼': 'ç¦®ç‰©'};

    createApp({
        setup() {
            const showModal = ref(false);
            const showSettings = ref(false);
            const viewingImage = ref(null);
            const fileInput = ref(null);
            const isAnalyzing = ref(false);
            const isTesting = ref(false);
            const isDownloadingModel = ref(false);
            const currentDownloadTarget = ref('');
            const statusText = ref('');
            const downloadedModels = ref([]);
            const modelLoading = reactive({ loaded: 0, total: 0, text: '' });
            const errorModal = reactive({ show: false, message: '' });

            const settings = reactive({
                rate: 0.2150,
                currencyCode: 'JPY',
                provider: 'gemini', 
                geminiKey: '',
                openaiKey: '',
                geminiModel: 'gemini-1.5-flash',
                openaiModel: 'gpt-4o'
            });

            const expenses = ref([]);
            const form = reactive({ id: null, date: '', store: '', itemTw: '', itemOriginal: '', price: '', tax: 'inc', image: null });

            onMounted(() => {
                const savedExp = localStorage.getItem('myTravel_expenses');
                const savedSet = localStorage.getItem('myTravel_settings');
                const savedModels = localStorage.getItem('myTravel_downloaded_models');
                if (savedExp) expenses.value = JSON.parse(savedExp);
                if (savedSet) {
                    const parsed = JSON.parse(savedSet);
                    if (parsed.apiKey && !parsed.geminiKey) parsed.geminiKey = parsed.apiKey;
                    Object.assign(settings, parsed);
                }
                if (savedModels) downloadedModels.value = JSON.parse(savedModels);
                resetForm();
            });

            const saveAll = () => {
                localStorage.setItem('myTravel_expenses', JSON.stringify(expenses.value));
                localStorage.setItem('myTravel_settings', JSON.stringify(settings));
            };

            const resetForm = () => {
                Object.assign(form, {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    store: '', itemTw: '', itemOriginal: '', price: '', tax: 'inc', image: null
                });
                modelLoading.total = 0;
            };

            const openAddModal = () => { resetForm(); showModal.value = true; };
            const closeModal = () => showModal.value = false;
            const saveSettings = () => { saveAll(); showSettings.value = false; };
            const triggerCamera = () => fileInput.value.click();
            const viewImage = (src) => { if(src) viewingImage.value = src; };

            const isKeyConfigured = computed(() => {
                if (settings.provider === 'gemini') return !!settings.geminiKey;
                if (settings.provider === 'openai') return !!settings.openaiKey;
                return true; 
            });
            const isAIProvider = computed(() => ['gemini', 'openai'].includes(settings.provider));
            const isOfflineOCR = computed(() => settings.provider === 'offline_ai');
            
            const getProviderName = () => {
                 if(settings.provider === 'gemini') return 'Gemini';
                 if(settings.provider === 'openai') return 'ChatGPT';
                 if(settings.provider === 'offline_ai') return 'é›¢ç·š OCR+AI';
                 return '';
            };

            const cleanJsonString = (str) => {
                let cleaned = str.replace(/```json/g, '').replace(/```/g, '');
                const firstOpen = cleaned.indexOf('{');
                const lastClose = cleaned.lastIndexOf('}');
                if (firstOpen !== -1 && lastClose !== -1) {
                    cleaned = cleaned.substring(firstOpen, lastClose + 1);
                }
                return cleaned;
            };

            const getPrompt = () => `
                You are a travel expense assistant. Analyze this receipt image for currency: ${settings.currencyCode}.
                Extract info into valid JSON only. No markdown.
                Fields: store, itemOriginal (Main item), itemTw (Translate item name to Traditional Chinese), price (number), date (YYYY-MM-DD).
                Example: {"store":"7-11","itemOriginal":"Coffee","itemTw":"å’–å•¡","price":500,"date":"2023-10-10"}
                If field not found, use empty string/0.
            `;

            // Online API Calls (Same as before)
            const callGemini = async (base64Image) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${settings.geminiModel}:generateContent?key=${settings.geminiKey}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: getPrompt() }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }], safetySettings: [{ category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }] }) });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            };

            const callOpenAI = async (base64Image) => {
                const url = 'https://api.openai.com/v1/chat/completions';
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.openaiKey}` }, body: JSON.stringify({ model: settings.openaiModel, messages: [ { role: "system", content: "You are a helpful assistant that outputs JSON." }, { role: "user", content: [ { type: "text", text: getPrompt() }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } } ] } ], response_format: { type: "json_object" } }) });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.choices[0].message.content;
            };

            const testAPIConnection = async () => {
                const isGemini = settings.provider === 'gemini';
                const key = isGemini ? settings.geminiKey : settings.openaiKey;
                if (!key) { alert("è«‹å…ˆè¼¸å…¥ API Key"); return; }
                isTesting.value = true;
                try {
                    if (isGemini) { await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.geminiModel}:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: "Hi" }] }] }) }).then(r => r.json()).then(d => { if(d.error) throw new Error(d.error.message); }); } 
                    else { await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model: settings.openaiModel, messages: [{role:"user",content:"Hi"}] }) }).then(r => r.json()).then(d => { if(d.error) throw new Error(d.error.message); }); }
                    alert(`âœ… ${isGemini?'Gemini':'OpenAI'} é€£ç·šæˆåŠŸï¼`);
                } catch (e) { alert("âŒ é€£ç·šå¤±æ•—ï¼š" + e.message); } finally { isTesting.value = false; }
            };

            // Main Analyze Entry
            const analyzeReceipt = async () => {
                if (settings.provider !== 'offline_ai' && !isKeyConfigured.value) { errorModal.message = "æœªè¨­å®šå°æ‡‰çš„ API Keyã€‚"; errorModal.show = true; return; }
                if (!form.image) return;
                isAnalyzing.value = true; 

                try {
                    if (settings.provider === 'offline_ai') {
                         await analyzeOffline();
                    } else {
                        statusText.value = `å‘¼å« ${getProviderName()} åˆ†æä¸­...`;
                        const base64Image = form.image.split(',')[1];
                        let rawText = settings.provider === 'gemini' ? await callGemini(base64Image) : await callOpenAI(base64Image);
                        statusText.value = "è³‡æ–™è§£æä¸­...";
                        const result = JSON.parse(cleanJsonString(rawText));
                        form.store = result.store || ''; form.itemTw = result.itemTw || ''; form.itemOriginal = result.itemOriginal || '';
                        if (result.price) { form.price = parseFloat(String(result.price).replace(/[^0-9.]/g, '')) || 0; }
                        if (result.date) form.date = result.date;
                    }
                } catch (error) { console.error(error); errorModal.message = error.message; errorModal.show = true; } finally { isAnalyzing.value = false; }
            };

            // --- Offline OCR & Translation Logic ---
            const downloadModel = async (lang) => {
                if(!window.TranslationService) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
                isDownloadingModel.value = true;
                currentDownloadTarget.value = lang;
                modelLoading.total = 100; modelLoading.loaded = 5; modelLoading.text = 'æº–å‚™ä¸‹è¼‰ä¸­...';
                try {
                    await window.TranslationService.getInstance(lang, (progress) => {
                        if(progress.status === 'progress' && progress.total) {
                            modelLoading.text = `ä¸‹è¼‰ä¸­... ${progress.file}`;
                            modelLoading.loaded = progress.loaded; modelLoading.total = progress.total;
                        }
                    });
                    if (!downloadedModels.value.includes(lang)) { downloadedModels.value.push(lang); localStorage.setItem('myTravel_downloaded_models', JSON.stringify(downloadedModels.value)); }
                    alert("æ¨¡å‹å·²æº–å‚™å°±ç·’ï¼");
                } catch(e) { alert("ä¸‹è¼‰å¤±æ•—: " + e.message); } finally { isDownloadingModel.value = false; currentDownloadTarget.value = ''; modelLoading.total = 0; }
            };
            const resetDownloadState = () => { isDownloadingModel.value = false; modelLoading.total = 0; downloadedModels.value = []; localStorage.removeItem('myTravel_downloaded_models'); alert("å·²é‡ç½®"); };

            const analyzeOffline = async () => {
                statusText.value = "Tesseract OCR è­˜åˆ¥ä¸­ (å¯èƒ½éœ€è¦ 10-20 ç§’)...";
                
                // 1. OCR Step
                const worker = await Tesseract.createWorker(settings.currencyCode === 'JPY' ? 'jpn' : (settings.currencyCode === 'KRW' ? 'kor' : 'eng'));
                const ret = await worker.recognize(form.image);
                await worker.terminate();
                const ocrText = ret.data.text;
                console.log("OCR Result:", ocrText);
                
                if(!ocrText || ocrText.length < 5) throw new Error("OCR ç„¡æ³•è­˜åˆ¥æ–‡å­—ï¼Œè«‹é‡æ‹ã€‚");

                // Simple Extraction Heuristics (Very Basic)
                // Try to find the longest line as item name
                const lines = ocrText.split('\n').filter(l => l.trim().length > 2);
                let longestLine = lines.sort((a, b) => b.length - a.length)[0] || '';
                form.itemOriginal = longestLine.substring(0, 30); // Limit length

                // Try to find price (largest number)
                const numbers = ocrText.match(/\d+[.,]\d+|\d+/g);
                if(numbers) {
                     const prices = numbers.map(n => parseFloat(n.replace(/,/g,''))).filter(n => !isNaN(n));
                     if(prices.length > 0) form.price = Math.max(...prices);
                }

                // 2. Translation Step
                statusText.value = "é›¢ç·šç¿»è­¯ä¸­...";
                await translateItem(); // Reuse manual translate function
            };

            const translateItem = async () => {
                const original = form.itemOriginal.trim();
                if(!original) { alert('è«‹å…ˆè¼¸å…¥åŸæ–‡å“å'); return; }
                
                if (settings.provider === 'google_trans') {
                    window.open(`https://translate.google.com/?sl=auto&tl=zh-TW&text=${encodeURIComponent(original)}&op=translate`, '_blank');
                } else if (settings.provider === 'dictionary') {
                    let found = null; for (const [key, val] of Object.entries(DICTIONARY)) { if (original.includes(key)) { found = val; break; } }
                    if (found) { form.itemTw = found; alert(`å·²ç¿»è­¯: ${found}`); } else { alert('å­—å…¸æœªæ‰¾åˆ°'); }
                } else if (settings.provider === 'offline_ai') {
                    if(!window.TranslationService) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
                    try {
                        modelLoading.text = "æ¨¡å‹æº–å‚™ä¸­..."; modelLoading.total = 100; modelLoading.loaded = 1; 
                        let targetLang = 'en'; 
                        if(settings.currencyCode === 'JPY') targetLang = 'ja';
                        if(settings.currencyCode === 'KRW') targetLang = 'ko';

                        const { translator, type } = await window.TranslationService.getInstance(targetLang, (p) => { if(p.status==='progress') { modelLoading.text=`è¼‰å…¥ä¸­: ${p.file}`; modelLoading.loaded=p.loaded; modelLoading.total=p.total; } });
                        modelLoading.text = "æ­£åœ¨ç¿»è­¯...";
                        
                        let output;
                        if (type === 'nllb') {
                            let src = 'eng_Latn';
                            if (targetLang === 'ja') src = 'jpn_Jpan';
                            if (targetLang === 'ko') src = 'kor_Hang';
                            output = await translator(original, { src_lang: src, tgt_lang: 'zho_Hant' });
                        } else {
                            output = await translator(original);
                        }
                        if(output && output[0]) form.itemTw = output[0].translation_text;
                        modelLoading.total = 0; 
                    } catch (e) { alert("é›¢ç·šç¿»è­¯éŒ¯èª¤: " + e.message); modelLoading.total = 0; }
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image(); img.src = evt.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const MAX = 1024; let w = img.width, h = img.height;
                        if (w > MAX) { h *= MAX / w; w = MAX; }
                        canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                        form.image = canvas.toDataURL('image/jpeg', 0.8);
                        if((isAIProvider.value && isKeyConfigured.value) || isOfflineOCR.value) analyzeReceipt();
                    };
                };
                reader.readAsDataURL(file); e.target.value = '';
            };

            const saveExpense = () => { if (!form.itemTw || !form.price) { alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š'); return; } expenses.value.push({ ...form }); saveAll(); closeModal(); };
            const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(i => i.id !== id); saveAll(); } };
            
            const currencyCode = computed(() => settings.currencyCode);
            const totalTWD = computed(() => expenses.value.reduce((sum, item) => sum + Math.round(item.price * settings.rate), 0));
            const groupedExpenses = computed(() => { const g = {}; [...expenses.value].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(i => { if(!g[i.date]) g[i.date]=[]; g[i.date].push(i); }); return g; });
            const formatCurrency = (v) => (!v && v !== 0) ? '-' : Number(v).toLocaleString();
            const formatDate = (d) => { if(!d) return ''; const date = new Date(d); return `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`; };
            const getDayLabel = (d) => { if(!d) return ''; return ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()]; };
            const getDayTotal = (i) => i.reduce((s, it) => s + Math.round(it.price * settings.rate), 0);

            return {
                showModal, showSettings, viewingImage, fileInput, isAnalyzing, statusText, isTesting, errorModal, isKeyConfigured, isAIProvider, isOfflineOCR, getProviderName,
                settings, form, currencyCode, groupedExpenses, totalTWD, modelLoading, isDownloadingModel, currentDownloadTarget, downloadedModels,
                openAddModal, closeModal, triggerCamera, handleImageUpload, analyzeReceipt, translateItem, saveExpense, saveSettings, deleteExpense, viewImage, downloadModel, resetDownloadState,
                testAPIConnection, formatCurrency, formatDate, getDayLabel, getDayTotal
            };
        }
    }).mount('#app');
</script>

</body>
</html>
